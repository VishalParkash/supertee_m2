<?php $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); $mediaPath = $objectManager->get('Magento\Store\Model\StoreManagerInterface') ->getStore() ->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA); ?> <h1>Set Design Area for the product customisation</h1><div><form data-form-part="product_form" method="post" action=""><?php if(!empty($block->getCurrentProduct()['id'])){ $objectmanager = \Magento\Framework\App\ObjectManager::getInstance(); $product_id = $block->getCurrentProduct()['id']; $productimages = array(); $product = $objectmanager ->create('Magento\Catalog\Model\Product')->load($product_id); $productimages = $product->getMediaGalleryImages(); $count = 0; $imageUrls = array(); if(!empty($productimages)){ foreach($productimages as $productimage) { $imageUrls[] = $productimage['url']; ?> <!-- <img src ="<?php ?>" id="currentProductId" style="display: none"> --><div class="canvases"><canvas id="canvas_<?php echo $count;?>" width="419" height="400"></canvas><input data-form-part="product_form" type="hidden" id="getImgUrl_<?php echo $count;?>" name="getImgUrl_<?php echo $count;?>" value="<?php echo $productimage['url']; ?>"><input data-form-part="product_form" type="hidden" id="bgImgWidth_<?php echo $count;?>" name="bgImgWidth_<?php echo $count;?>" value=""><input data-form-part="product_form" type="hidden" id="bgImgHeight_<?php echo $count;?>" name="bgImgHeight_<?php echo $count;?>" value=""><input data-form-part="product_form" type="hidden" id="selectableCordLeft_<?php echo $count;?>" name="selectableCordLeft_<?php echo $count;?>" value=""><input data-form-part="product_form" type="hidden" id="selectableCordTop_<?php echo $count;?>" name="selectableCordTop_<?php echo $count;?>" value=""><input data-form-part="product_form" type="hidden" id="height_<?php echo $count;?>" name="height_<?php echo $count;?>" value=""><input data-form-part="product_form" type="hidden" id="width_<?php echo $count;?>" name="width_<?php echo $count;?>" value=""><input data-form-part="product_form" type="hidden" id="productSide_<?php echo $count;?>" name="productSide_<?php echo $count;?>" value="<?php echo $product_id?>_<?php echo $count;?>"></div><?php $count++; } } } ?> <input data-form-part="product_form" type="hidden" name="loopingCount" value="<?php if(!empty($imageUrls)){ echo count($imageUrls); }else{ echo '';}?>"><!-- <img src ="http://127.0.0.1/supertee/pub/media/BlankProduct/forDesign.png" id="currentProductId" style="display: none"> --><!-- <input data-form-part="product_form" type="hidden" name="canvasHeight" id="canvasHeight" value=""><input data-form-part="product_form" type="hidden" name="canvasWidth" id="canvasWidth" value=""><input data-form-part="product_form" type="hidden" name="canvasXCdnt" id="canvasXCdnt" value=""><input data-form-part="product_form" type="hidden" name="canvasYCdnt" id="canvasYCdnt" value=""> --></div><p>Drag the mouse to create an area to set for the logo and tagline.</p></form><script type="text/javascript">

    require([ 'jquery', 'jquery/ui', 'bootstrap4', 'fabric'], function($){ 
        $( document ).ready(function() {


            

var canvases = {};

var images = '<?php  ?>';
var images = '<?php if(!empty($imageUrls)){ echo json_encode($imageUrls); }else{ echo '';}?>';
if(images != ""){
var loopImages = JSON.parse(images);
var loopLength = JSON.parse(images).length;

for (var p = 0; p < loopLength; p++) {
    canvases[p] = new fabric.Canvas('canvas_' + p);
    var canvasWidth = canvases[p].getWidth();
    var canvasHeight = canvases[p].getHeight();
    
    
    
    

    

    var canvasImageBackground = loopImages[p];

            updateDimensions(canvasImageBackground, p);
            setTimeout( function (p) {
            console.log("p value"+p);
            console.log('#getImgUrl_'+p);
            var setImageBackground = loopImages[p];

            console.log("canvasImageBackground_"+setImageBackground);
            var clipRectangle = new fabric.Rect({
            originX: 'left',
            originY: 'top',
            left: 150,
            top: 150,
            width: 100,
            height: 100,
            fill: 'transparent',
            /* use transparent for no fill */
            strokeDashArray: [10, 10],
            stroke: 'red',
            selectable: true
        });
        
        
        
        
        
    
    var getImgWidth= $("#bgImgWidth_"+p).val();
    var getImgHeight= $("#bgImgHeight_"+p).val();

    console.log("in getImgWidth "+getImgWidth);
    console.log("in getImgHeight "+getImgHeight);

    var getPosition = getPositions(getImgWidth, getImgHeight);

    canvases[p].setBackgroundImage(setImageBackground, canvases[p].renderAll.bind(canvases[p]), {
    top: getPosition.top,
    left: getPosition.left,
    originX: 'left',
    originY: 'top',
    scaleX: getPosition.scaleFactor,
    scaleY: getPosition.scaleFactor
    });
    canvases[p].add(clipRectangle);

  }, (p*1000), p);
}


function addDeleteBtn(x, y){
    $(".deleteBtn").remove(); 
    var btnLeft = x-10;
    var btnTop = y-10;
    var deleteBtn = '<img src="<?php echo $mediaPath?>/misc/trash_bin.ico" class="deleteBtn" style="position:absolute;top:'+btnTop+'px;left:'+btnLeft+'px;cursor:pointer;width:20px;height:20px;"/>';
    $(".canvas-container").append(deleteBtn);
}
































function getdimensions(canvas, index){

    
canvases[index].on("object:modified", function (e) {
    var activeObject = e.target;
    if (!activeObject) {
      return;
    }
    var width = activeObject.getScaledWidth();
    var height = activeObject.getScaledHeight();

    
    

    
    

    console.log("actObjwidth"+width)
    console.log("actObjheight"+height)
    $('#height_'+index).val(height);
    $('#width_'+index).val(width);


});
}
function getCordinates(canvas, index){


        
    
    
    
    
    canvases[index].on("object:moving", function(e) {
    var actObj = e.target;
    
    var coords = actObj.calcCoords();
    var left = coords.tl.x;
    var top = coords.tl.y;
    console.log("coords:"+coords);
    console.log("left:"+left+", top:"+top)
    $('#selectableCordLeft_'+index).val(left);
    $('#selectableCordTop_'+index).val(top);

    
    
})
    
    

    
    
    
    
}



var canvasId;
$(document).on("click", ".canvases", function(e){
    canvasId = (jQuery(this).find(".lower-canvas").attr("id"));
    var res = canvasId.split("_");
    getCordinates(canvasId, res[1]);
    getdimensions(canvasId, res[1]);


    
    
    console.log("currentID ");
    console.log(jQuery(this).attr("class"));
})











    















        
        


        

    















function updateDimensions(img, index){
    var bgImg = new Image();
    bgImg.src = img;
    $(bgImg).on('load',function(){
        var bgImgWidth = bgImg.width;
        var bgImgHeight = bgImg.height;

        $('#bgImgWidth_'+index).val(bgImgWidth);
        $('#bgImgHeight_'+index).val(bgImgHeight);

        console.log("bgImgWidth index"+index+bgImgWidth);
        console.log("bgImgHeight index"+index+bgImgHeight);
    });
}

        function getPositions(imgWidth, imgHeight){

                console.log(imgWidth);
                console.log(imgHeight);
                var canvasAspect = canvasWidth / canvasHeight;
                var imgAspect = imgWidth / imgHeight;
                var left, top, scaleFactor;

                if (canvasAspect >= imgAspect) {
                    var scaleFactor = canvasWidth / imgWidth;
                    left = 0;
                    top = -((imgHeight * scaleFactor) - canvasHeight) / 2;
                } else {
                    var scaleFactor = canvasHeight / imgHeight;
                    top = 0;
                    left = -((imgWidth * scaleFactor) - canvasWidth) / 2;
                }

                var dimensions = new Object();
                dimensions['left'] = left;
                dimensions['top'] = top;
                dimensions['scaleFactor'] = scaleFactor;

                console.log(dimensions);
                return dimensions;
            }






























































        




}
    });
    });</script>